-- Mecha Prevention Captcha Solver - Fixed Visible Error Version
-- Standalone Debug Heavy - สำหรับ Untitled RPG (MacroGui + MacroClient)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local Enabled = true  -- เปิด auto ทันทีเพื่อทดสอบ
local IsSolving = false
local LastSolveTime = 0

local function debug(msg)
    warn("[Mecha Debug] " .. msg)  -- ใช้ warn ให้เห็นชัดใน console สีเหลือง
end

-- หา GUI (ปรับให้เจอ MacroGui)
local function FindMechaGui()
    debug("สแกน PlayerGui ทั้งหมด...")
    local pg = LocalPlayer:WaitForChild("PlayerGui", 10)
    if not pg then 
        debug("PlayerGui ไม่โหลดทัน!")
        return nil 
    end
    
    for _, sg in ipairs(pg:GetChildren()) do
        if sg:IsA("ScreenGui") and sg.Enabled then
            local nameLower = sg.Name:lower()
            debug("เจอ ScreenGui: " .. sg.Name .. " (Enabled: " .. tostring(sg.Enabled) .. ")")
            
            if nameLower:find("mecha") or nameLower:find("prevention") or nameLower:find("macro") or nameLower == "macrogui" then
                debug(">>> พบ GUI ที่ตรงเงื่อนไข: " .. sg.Name)
                return sg
            end
            
            -- Fallback เช็คข้อความ
            for _, lbl in ipairs(sg:GetDescendants()) do
                if lbl:IsA("TextLabel") and lbl.Text and (
                    lbl.Text:find("Mecha Prevention") or 
                    lbl.Text:find("다음 숫자를 입력해주세요") or 
                    lbl.Text:find("숫자") or lbl.Text:find("입력")
                ) then
                    debug(">>> พบ GUI โดยข้อความใน: " .. sg.Name)
                    return sg
                end
            end
        end
    end
    debug("ไม่พบ Macro/Mecha GUI ใด ๆ เลย")
    return nil
end

-- ดึง code (4-6 หลัก)
local function ExtractCode(gui)
    for _, obj in ipairs(gui:GetDescendants()) do
        if obj:IsA("TextLabel") or obj:IsA("TextBox") then
            local text = (obj.Text or ""):gsub("[^%d]", "")
            local code = text:match("%d%d%d%d+")
            if code and #code >= 4 then
                debug("พบ code: " .. code .. " จาก " .. obj:GetFullName())
                return code
            end
        end
    end
    debug("ไม่เจอ code ตัวเลข 4+ หลัก")
    return nil
end

-- หา gray bar - เวอร์ชันปลอดภัย ไม่ error บน LocalScript/MacroClient
local function FindGrayBar(gui)
    debug("เริ่มสแกนหา gray bar / input field...")
    for _, obj in ipairs(gui:GetDescendants()) do
        -- กรองเฉพาะ GuiObject ที่มี .Visible จริง ๆ (Frame, TextBox, etc.)
        if obj:IsA("GuiObject") and obj.Visible then
            local nameLower = obj.Name:lower()
            local isInputLike = nameLower:find("input") or nameLower:find("bar") or nameLower:find("trigger") or 
                                nameLower:find("keyinput") or nameLower:find("field")
            
            local color = obj.BackgroundColor3
            local isGrayish = color and 
                (math.abs(color.R - 0.5) < 0.25 and 
                 math.abs(color.G - 0.5) < 0.25 and 
                 math.abs(color.B - 0.5) < 0.25)  -- ขยายช่วงสีเทาเผื่อ
            
            if isGrayish or isInputLike then
                debug("พบ candidate gray/input: " .. obj:GetFullName())
                debug("   - Class: " .. obj.ClassName .. " | ชื่อ: " .. obj.Name .. " | สี: " .. tostring(color))
                return obj
            end
        end
    end
    debug("ไม่พบ gray bar / input field ที่ตรงเงื่อนไข")
    return nil
end

-- หา keypad buttons (0-9)
local function FindKeypad(gui)
    debug("สแกนหา keypad...")
    for _, frame in ipairs(gui:GetDescendants()) do
        if frame:IsA("Frame") or frame:IsA("GuiObject") then
            local btns = {}
            local count = 0
            for _, child in ipairs(frame:GetChildren()) do
                if child:IsA("TextButton") and child.Text:match("^%d$") and child.Visible then
                    btns[child.Text] = child
                    count = count + 1
                end
            end
            if count >= 10 then
                debug("พบ keypad ครบ " .. count .. " ปุ่ม!")
                return btns
            end
        end
    end
    debug("ไม่พบ keypad ที่มีปุ่มตัวเลขครบ")
    return nil
end

-- คลิก object ปลอดภัย
local function ClickObject(obj)
    if not obj then return end
    pcall(function()
        if obj.MouseButton1Click then
            obj.MouseButton1Click:Fire()
            debug("Fire MouseButton1Click บน: " .. obj:GetFullName())
        end
    end)
end

-- ฟังก์ชันหลักแก้ captcha
local function SolveMechaCaptcha()
    if IsSolving or tick() - LastSolveTime < 2.5 then return end
    IsSolving = true
    LastSolveTime = tick()
    
    debug("=== เริ่ม Solve Mecha Captcha ===")
    local gui = FindMechaGui()
    if not gui then 
        debug("หยุด - ไม่เจอ GUI")
        IsSolving = false 
        return 
    end
    
    local code = ExtractCode(gui)
    if not code then 
        debug("หยุด - ไม่เจอ code")
        IsSolving = false 
        return 
    end
    
    debug("Code ที่จะกด: " .. code)
    
    -- Reset ถ้ามี
    for _, btn in ipairs(gui:GetDescendants()) do
        if btn:IsA("TextButton") and (btn.Text:find("초기화") or btn.Text:find("Reset") or btn.Text:find("clear")) then
            ClickObject(btn)
            debug("กด Reset")
            task.wait(0.7 + math.random() * 0.3)
        end
    end
    
    -- กด gray bar
    local bar = FindGrayBar(gui)
    if bar then
        ClickObject(bar)
        task.wait(0.6 + math.random() * 0.4)
        ClickObject(bar)  -- กดซ้ำเผื่อครั้งแรกไม่ตอบสนอง
        debug("กด gray bar เรียบร้อย")
    else
        debug("ไม่เจอ bar - ข้ามขั้นตอนเปิด keypad")
    end
    
    task.wait(1.3 + math.random() * 0.5)  -- รอ keypad โผล่
    
    local keypad = FindKeypad(gui)
    if not keypad then
        debug("หยุด - ไม่เจอ keypad")
        IsSolving = false
        return
    end
    
    -- กดตัวเลข
    for digit in code:gmatch(".") do
        local btn = keypad[digit]
        if btn then
            ClickObject(btn)
            debug("กดตัวเลข: " .. digit)
            task.wait(0.6 + math.random() * 0.35)  -- ช้า + random
        else
            debug("ขาดปุ่มสำหรับตัวเลข: " .. digit .. " !")
        end
    end
    
    debug("กดครบแล้ว - รอ server ตรวจสอบ...")
    task.wait(3.0 + math.random() * 1.0)
    IsSolving = false
    debug("=== จบรอบ Solve ===")
end

-- เริ่ม loop auto
debug("เริ่ม auto solver - เช็คทุก ~2-3 วินาที")
RunService.Heartbeat:Connect(function()
    if Enabled and tick() % 2.5 < 0.2 and not IsSolving then
        SolveMechaCaptcha()
    end
end)

print("Mecha Captcha Solver Fixed Version โหลดแล้ว!")
print("เปิด console (F9) ดู warn สีเหลืองเพื่อ debug")
print("รอ captcha เด้ง แล้วดู log ว่าพบ GUI / bar / code ไหม")
