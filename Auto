-- Mecha Prevention Solver - No UI Library Version (Debug Heavy)
-- รันแบบ standalone ไม่พึ่ง loadstring ภายนอก

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local Enabled = true  -- เปิด auto ทันทีเพื่อทดสอบ
local IsSolving = false
local LastSolveTime = 0

local function debug(msg)
    warn("[Mecha Debug] " .. msg)  -- ใช้ warn เพื่อให้เห็นชัดใน console
end

-- หา GUI (ปรับให้กว้างขึ้น)
local function FindMechaGui()
    debug("กำลังสแกน PlayerGui...")
    local pg = LocalPlayer:WaitForChild("PlayerGui", 5)
    if not pg then debug("PlayerGui ไม่โหลด") return nil end
    
    for _, sg in ipairs(pg:GetChildren()) do
        if sg:IsA("ScreenGui") and sg.Enabled then
            local name = sg.Name:lower()
            if name:find("mecha") or name:find("prevention") or name:find("macro") or name:find("captcha") then
                debug("พบ GUI โดยชื่อ: " .. sg.Name)
                return sg
            end
            
            -- เช็คข้อความในลูกหลาน
            for _, lbl in ipairs(sg:GetDescendants()) do
                if lbl:IsA("TextLabel") and lbl.Text and (
                    lbl.Text:find("Mecha Prevention") or 
                    lbl.Text:find("다음 숫자를 입력해주세요") or 
                    lbl.Text:find("숫자") or 
                    lbl.Text:find("입력")
                ) then
                    debug("พบ GUI โดยข้อความใน: " .. sg.Name)
                    return sg
                end
            end
        end
    end
    debug("ไม่พบ Mecha GUI ใด ๆ")
    return nil
end

-- ... (ส่วน ExtractCode, FindGrayBar, FindKeypad, ClickObject เหมือนเดิมจากเวอร์ชันก่อนหน้า ผม copy มาให้ครบด้านล่าง)

local function ExtractCode(gui)
    for _, obj in ipairs(gui:GetDescendants()) do
        if obj:IsA("TextLabel") or obj:IsA("TextBox") then
            local text = (obj.Text or ""):gsub("[^%d]", "")
            local code = text:match("%d%d%d%d+")
            if code and #code >= 4 then
                debug("พบ code: " .. code)
                return code
            end
        end
    end
    return nil
end

local function FindGrayBar(gui)
    for _, obj in ipairs(gui:GetDescendants()) do
        if obj.Visible and (obj:IsA("Frame") or obj:IsA("TextBox") or obj:IsA("TextButton")) then
            local c = obj.BackgroundColor3
            local name = obj.Name:lower()
            if (c and math.abs(c.R - 0.5) < 0.15 and math.abs(c.G - 0.5) < 0.15 and math.abs(c.B - 0.5) < 0.15) or
               name:find("input") or name:find("bar") or name:find("trigger") then
                debug("พบ gray bar candidate: " .. obj:GetFullName())
                return obj
            end
        end
    end
    return nil
end

local function FindKeypad(gui)
    for _, f in ipairs(gui:GetDescendants()) do
        if f:IsA("Frame") then
            local btns = {}
            local cnt = 0
            for _, b in ipairs(f:GetChildren()) do
                if b:IsA("TextButton") and b.Text:match("^%d$") then
                    btns[b.Text] = b
                    cnt += 1
                end
            end
            if cnt >= 10 then
                debug("พบ keypad ครบ: " .. cnt .. " ปุ่ม")
                return btns
            end
        end
    end
    return nil
end

local function ClickObject(obj)
    if not obj then return end
    pcall(function() obj.MouseButton1Click:Fire() end)
    debug("คลิก: " .. (obj.Name or "nil"))
end

local function SolveMechaCaptcha()
    if IsSolving or tick() - LastSolveTime < 2 then return end
    IsSolving = true
    LastSolveTime = tick()
    
    debug("เริ่ม SolveCaptcha...")
    local gui = FindMechaGui()
    if not gui then IsSolving = false return end
    
    local code = ExtractCode(gui)
    if not code then debug("ไม่เจอ code") IsSolving = false return end
    
    debug("Code ที่เจอ: " .. code)
    
    -- Reset ถ้ามี
    for _, b in ipairs(gui:GetDescendants()) do
        if b:IsA("TextButton") and (b.Text:find("초기화") or b.Text:find("Reset")) then
            ClickObject(b)
            task.wait(0.6)
        end
    end
    
    local bar = FindGrayBar(gui)
    if bar then
        ClickObject(bar)
        task.wait(0.5 + math.random()*0.3)
        ClickObject(bar)  -- กดซ้ำเผื่อ
    end
    
    task.wait(1.2)
    
    local keypad = FindKeypad(gui)
    if not keypad then debug("ไม่เจอ keypad") IsSolving = false return end
    
    for digit in code:gmatch(".") do
        local btn = keypad[digit]
        if btn then
            ClickObject(btn)
            task.wait(0.55 + math.random()*0.3)
        else
            debug("ขาดปุ่ม: " .. digit)
        end
    end
    
    debug("กดครบแล้ว - รอ verify")
    task.wait(2.5)
    IsSolving = false
end

-- Loop ง่าย ๆ
if Enabled then
    debug("เริ่ม auto solver (no UI)")
    RunService.Heartbeat:Connect(function()
        if tick() % 1.2 < 0.1 then
            SolveMechaCaptcha()
        end
    end)
end

print("Mecha Solver Debug Mode โหลดแล้ว - ดู console ด้วย warn")
